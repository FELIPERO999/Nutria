<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracking</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        #map {
            width: 1920px;  /* Ancho del mapa */
            height: 1080px; /* Alto del mapa */
        }
        #controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">GPS Tracking</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div id="map"></div>
                <div id="controls" class="d-flex justify-content-between">
                    <button id="startBtn" class="btn btn-success">Iniciar Recorrido</button>
                    <button id="stopBtn" class="btn btn-danger" disabled>Terminar Recorrido</button>
                    <select id="recorridosSelect" class="form-select w-25">
                        <option value="">Seleccionar Recorrido</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Bootstrap JS (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Inicializar el mapa con un mayor nivel de zoom
        var map = L.map('map').setView([0, 0], 18); // Cambia el zoom inicial a 18
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 22 // Permitir hacer zoom hasta el nivel 22
        }).addTo(map);

        var isTracking = false;
        var trackCoordinates = [];
        var polyline;  // Polilínea para trazar el recorrido
        var recorridos = [];  // Lista de recorridos anteriores
        var recorridoId = 0;  // ID para cada recorrido guardado

        // Botones de control
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recorridosSelect = document.getElementById('recorridosSelect');

        // Función para iniciar el seguimiento
        startBtn.addEventListener('click', () => {
            isTracking = true;
            trackCoordinates = [];  // Reiniciar el array de coordenadas
            startBtn.disabled = true;
            stopBtn.disabled = false;
            console.log("Recorrido Iniciado");
        });

        // Función para detener el seguimiento y guardar el recorrido
        stopBtn.addEventListener('click', () => {
            isTracking = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;

            if (trackCoordinates.length > 0) {
                guardarRecorrido(trackCoordinates);  // Guardar recorrido
            }

            // Eliminar la polilínea del mapa
            if (polyline) {
                map.removeLayer(polyline);
            }

            console.log("Recorrido Terminado");
        });

        // Función para guardar el recorrido en la lista de recorridos
        function guardarRecorrido(coordenadas) {
            recorridoId++;
            recorridos.push({
                id: recorridoId,
                coords: coordenadas
            });

            // Añadir opción al selector de recorridos
            const option = document.createElement('option');
            option.value = recorridoId;
            option.text = `Recorrido ${recorridoId}`;
            recorridosSelect.appendChild(option);

            console.log("Recorrido Guardado:", coordenadas);
        }

        // Función para visualizar un recorrido seleccionado
        recorridosSelect.addEventListener('change', (event) => {
            const recorridoSeleccionadoId = parseInt(event.target.value);
            const recorridoSeleccionado = recorridos.find(r => r.id === recorridoSeleccionadoId);

            if (recorridoSeleccionado) {
                // Eliminar cualquier polilínea actual
                if (polyline) {
                    map.removeLayer(polyline);
                }

                // Dibujar el recorrido seleccionado
                polyline = L.polyline(recorridoSeleccionado.coords, { color: 'blue' }).addTo(map);
                map.fitBounds(polyline.getBounds());

                console.log("Visualizando Recorrido:", recorridoSeleccionadoId);
            }
        });

        // Función para obtener datos de la API
        function fetchData() {
            var apiUrl = 'https://api.thingspeak.com/channels/2680232/feeds/last.json?api_key=8DO3OKCMKLZV7ZXU';

            fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                updateMarker(data);
            })
            .catch(error => console.error('Error al obtener datos:', error));
        }

        // Función para actualizar el marcador y dibujar la ruta
        function updateMarker(location) {
            var latLng = [parseFloat(location.field1), parseFloat(location.field2)];

            // Si el seguimiento está activo, almacenar las coordenadas y dibujar la línea
            if (isTracking) {
                trackCoordinates.push(latLng);  // Guardar la posición actual
                if (polyline) {
                    map.removeLayer(polyline);  // Eliminar la línea previa si existe
                }
                polyline = L.polyline(trackCoordinates, { color: 'blue' }).addTo(map);  // Dibujar la nueva línea
            }

            // Remover el marcador existente
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Añadir un nuevo marcador basado en la respuesta del API
            var marker = L.marker(latLng).addTo(map);
            map.setView(latLng, map.getZoom());
        }

        // Llamar a fetchData cuando se cargue la página
        fetchData();

        // Obtener datos cada 10 segundos
        setInterval(fetchData, 10000);
    </script>
</body>
</html>
